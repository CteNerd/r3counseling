service: r3counseling-backend

provider:
  name: aws
  runtime: nodejs20.x
  region: us-east-1
  httpApi:
    cors: true
  environment:
    TABLE_NAME: ${self:custom.tableName}
    NOTIFY_TO: ${ssm:/r3counseling/notify_to}
    ADMIN_EMAIL: ${ssm:/r3counseling/admin_email}
    FROM_EMAIL: ${ssm:/r3counseling/from_email}
    TURNSTILE_SECRET_ARN: ${self:custom.turnstileSecretArn}
  iam:
    role:
      statements:
        - Effect: Allow
          Action: 
            - dynamodb:PutItem
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.tableName}
        - Effect: Allow
          Action:
            - ses:SendEmail
            - ses:SendRawEmail
          Resource: "*"
        - Effect: Allow
          Action:
            - secretsmanager:GetSecretValue
          Resource: ${self:custom.turnstileSecretArn}
        - Effect: Allow
          Action:
            - ssm:GetParameter
            - ssm:GetParameters
            - ssm:GetParametersByPath
          Resource:
            - arn:aws:ssm:${self:provider.region}:*:parameter/r3counseling/*

functions:
  lead:
    handler: ${self:custom.leadHandler}
    events:
      - httpApi:
          path: /lead
          method: POST

plugins:
  - serverless-offline
  - serverless-domain-manager

custom:
  tableName: Contacts
  turnstileSecretArn: arn:aws:secretsmanager:${self:provider.region}:${aws:accountId}:secret:/r3counseling/turnstile_secret-*
  leadHandler: dist/handlers/lead.handler
  customDomain:
    domainName: api.r3counseling.com
    certificateArn: arn:aws:acm:us-east-1:425061472162:certificate/4f86c517-4143-4464-a226-d94f2efed792
    createRoute53Record: false
    endpointType: 'regional'
    securityPolicy: tls_1_2
    apiType: http
    autoDomain: true
  serverless-offline:
    httpPort: 3001
    host: 0.0.0.0

resources:
  Resources:
    ContactsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableName}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: leadId
            AttributeType: S
        KeySchema:
          - AttributeName: leadId
            KeyType: HASH